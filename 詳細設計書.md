# NextExplorer - 詳細設計書

## 1. クラス設計

### 1.1 プレゼンテーション層

#### MainWindow.xaml / MainWindow.xaml.cs
- **役割**: メインウィンドウのUI制御
- **主要メソッド**:
  - `InitializeComponent()`: UI初期化
  - `OnLoadedAsync()`: ウィンドウロード時の処理
  - `OnClosing()`: ウィンドウクローズ時の処理

#### MainViewModel.cs
- **役割**: メインウィンドウのビューモデル
- **プロパティ**:
  - `CurrentFolders`: 現在開かれているフォルダ一覧
  - `SavedSessions`: 保存されたセッション一覧
  - `SelectedSession`: 選択されたセッション
- **コマンド**:
  - `RefreshFoldersCommand`: フォルダ状態更新
  - `SaveSessionCommand`: セッション保存
  - `LoadSessionCommand`: セッション読込
  - `DeleteSessionCommand`: セッション削除

### 1.2 ビジネス層

#### FolderSessionManager.cs
- **役割**: セッション管理の中核
- **主要メソッド**:
  ```csharp
  Task<List<FolderInfo>> GetCurrentOpenFoldersAsync()
  Task SaveSessionAsync(string name, List<FolderInfo> folders)
  Task<List<SessionInfo>> LoadAllSessionsAsync()
  Task DeleteSessionAsync(string sessionId)
  Task<bool> RestoreSessionAsync(string sessionId)
  ```

#### WindowsExplorerService.cs
- **役割**: Windows Explorer との連携
- **主要メソッド**:
  ```csharp
  List<FolderInfo> GetOpenExplorerWindows()
  bool OpenFolder(string path)
  bool IsFolderAccessible(string path)
  ```

#### SessionValidator.cs
- **役割**: セッションデータの検証
- **主要メソッド**:
  ```csharp
  ValidationResult ValidateSession(SessionInfo session)
  List<string> GetInaccessiblePaths(List<FolderInfo> folders)
  SessionInfo SanitizeSession(SessionInfo session)
  ```

### 1.3 データアクセス層

#### SessionRepository.cs
- **役割**: セッションデータの永続化
- **主要メソッド**:
  ```csharp
  Task<List<SessionInfo>> LoadSessionsAsync()
  Task SaveSessionsAsync(List<SessionInfo> sessions)
  Task<SessionInfo> GetSessionByIdAsync(string id)
  Task DeleteSessionAsync(string id)
  ```

#### ConfigurationManager.cs
- **役割**: アプリケーション設定管理
- **主要メソッド**:
  ```csharp
  Task<AppConfig> LoadConfigAsync()
  Task SaveConfigAsync(AppConfig config)
  T GetSetting<T>(string key, T defaultValue)
  void SetSetting<T>(string key, T value)
  ```

### 1.4 システム連携層

#### Win32ApiWrapper.cs
- **役割**: Windows API の C# ラッパー
- **主要メソッド**:
  ```csharp
  [DllImport] static extern IntPtr FindWindow(string className, string windowName)
  [DllImport] static extern bool EnumWindows(EnumWindowsProc proc, IntPtr param)
  [DllImport] static extern int GetWindowText(IntPtr hWnd, StringBuilder text, int count)
  List<IntPtr> GetExplorerWindowHandles()
  string GetWindowPath(IntPtr handle)
  ```

## 2. データフロー設計

### 2.1 フォルダ取得フロー
```
[ユーザー操作] 
    ↓
[MainViewModel.RefreshFoldersCommand]
    ↓ 
[FolderSessionManager.GetCurrentOpenFoldersAsync()]
    ↓
[WindowsExplorerService.GetOpenExplorerWindows()]
    ↓
[Win32ApiWrapper (Windows API)]
    ↓
[FolderInfo リスト生成]
    ↓
[UI更新]
```

### 2.2 セッション保存フロー
```
[ユーザー入力: セッション名]
    ↓
[MainViewModel.SaveSessionCommand]
    ↓
[SessionValidator.ValidateSession()]
    ↓
[FolderSessionManager.SaveSessionAsync()]
    ↓
[SessionRepository.SaveSessionsAsync()]
    ↓
[JSON ファイル書き込み]
    ↓
[UI更新]
```

### 2.3 セッション復元フロー
```
[ユーザー選択: セッション]
    ↓
[MainViewModel.LoadSessionCommand]
    ↓
[SessionValidator.GetInaccessiblePaths()] (事前チェック)
    ↓
[ユーザー確認ダイアログ] (問題がある場合)
    ↓
[FolderSessionManager.RestoreSessionAsync()]
    ↓
[WindowsExplorerService.OpenFolder()] (各フォルダ)
    ↓
[エラーハンドリング & ログ出力]
```

## 3. エラーハンドリング

### 3.1 例外分類
- **SystemException**: Windows API呼び出しエラー
- **UnauthorizedAccessException**: フォルダアクセス権限エラー
- **FileNotFoundException**: 存在しないフォルダパス
- **JsonException**: データファイル破損
- **InvalidOperationException**: 不正な操作

### 3.2 エラー処理方針
- 致命的エラー: アプリケーション終了 + エラーログ
- 回復可能エラー: ユーザー通知 + 処理続行
- 警告レベル: ログ出力のみ

## 4. パフォーマンス最適化

### 4.1 非同期処理
- ファイルI/O操作: `async/await` パターン
- Windows API呼び出し: `Task.Run()` でバックグラウンド実行
- UI更新: `Dispatcher.BeginInvoke()` でUIスレッド同期

### 4.2 キャッシュ戦略
- 最近アクセスしたセッション: メモリキャッシュ (30分)
- フォルダ存在チェック結果: 一時キャッシュ (5分)
- アプリケーション設定: 起動時ロード

### 4.3 メモリ管理
- IDisposable パターンの徹底
- WeakReference の活用
- イベントハンドラーの適切な解除

## 5. セキュリティ設計

### 5.1 データ暗号化
```csharp
public class DataEncryption
{
    public static string Encrypt(string data, string key)
    {
        // AES暗号化の実装
    }
    
    public static string Decrypt(string encryptedData, string key)
    {
        // AES復号化の実装
    }
}
```

### 5.2 パス検証
```csharp
public static class PathValidator
{
    public static bool IsValidPath(string path)
    {
        // パスインジェクション攻撃の防止
        // 不正文字のチェック
        // 長さ制限の確認
    }
    
    public static string SanitizePath(string path)
    {
        // パスの正規化
    }
}
```

## 6. ログ設計

### 6.1 ログレベル
- **Debug**: 開発時のデバッグ情報
- **Info**: 通常の操作ログ
- **Warning**: 警告（処理は継続）
- **Error**: エラー（処理に影響）
- **Fatal**: 致命的エラー（アプリ終了）

### 6.2 ログ出力先
- ファイル: `%APPDATA%\NextExplorer\logs\app_{date}.log`
- コンソール: デバッグビルド時のみ
- イベントログ: 致命的エラーのみ

## 7. テスト設計

### 7.1 単体テスト対象
- `FolderSessionManager` クラス
- `WindowsExplorerService` クラス
- `SessionValidator` クラス
- `PathValidator` クラス

### 7.2 統合テスト対象
- セッション保存→読込の一連フロー
- Windows API連携部分
- ファイルI/O処理

### 7.3 UIテスト対象
- メイン画面の操作フロー
- エラーダイアログの表示確認