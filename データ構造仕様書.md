# NextExplorer - データ構造仕様書

## 1. データモデル定義

### 1.1 FolderInfo クラス
```csharp
public class FolderInfo
{
    /// <summary>フォルダの絶対パス</summary>
    [Required]
    [MaxLength(260)]
    public string Path { get; set; }
    
    /// <summary>フォルダの表示名</summary>
    [MaxLength(255)]
    public string DisplayName { get; set; }
    
    /// <summary>フォルダが存在するかどうか</summary>
    public bool Exists { get; set; }
    
    /// <summary>フォルダにアクセス可能かどうか</summary>
    public bool IsAccessible { get; set; }
    
    /// <summary>フォルダのアイコンパス（オプション）</summary>
    [MaxLength(260)]
    public string IconPath { get; set; }
    
    /// <summary>最後にアクセスした日時</summary>
    public DateTime LastAccessed { get; set; }
    
    /// <summary>フォルダタイプ（Local, Network, Cloud等）</summary>
    public FolderType Type { get; set; }
}

public enum FolderType
{
    Local,      // ローカルドライブ
    Network,    // ネットワークドライブ
    Cloud,      // クラウドストレージ
    Removable   // リムーバブルドライブ
}
```

### 1.2 SessionInfo クラス
```csharp
public class SessionInfo
{
    /// <summary>セッションの一意識別子</summary>
    [Required]
    public string Id { get; set; }
    
    /// <summary>セッション名</summary>
    [Required]
    [MaxLength(100)]
    public string Name { get; set; }
    
    /// <summary>セッションの説明</summary>
    [MaxLength(500)]
    public string Description { get; set; }
    
    /// <summary>セッションに含まれるフォルダ一覧</summary>
    [Required]
    public List<FolderInfo> Folders { get; set; }
    
    /// <summary>セッション作成日時</summary>
    public DateTime CreatedAt { get; set; }
    
    /// <summary>セッション最終更新日時</summary>
    public DateTime UpdatedAt { get; set; }
    
    /// <summary>最後に使用した日時</summary>
    public DateTime LastUsed { get; set; }
    
    /// <summary>使用回数</summary>
    public int UsageCount { get; set; }
    
    /// <summary>タグ（分類用）</summary>
    public List<string> Tags { get; set; }
    
    /// <summary>お気に入りフラグ</summary>
    public bool IsFavorite { get; set; }
    
    /// <summary>自動生成されたセッションかどうか</summary>
    public bool IsAutoGenerated { get; set; }
}
```

### 1.3 AppConfig クラス
```csharp
public class AppConfig
{
    /// <summary>アプリケーション設定バージョン</summary>
    public string Version { get; set; } = "1.0.0";
    
    /// <summary>起動時の動作設定</summary>
    public StartupSettings Startup { get; set; } = new();
    
    /// <summary>UI関連設定</summary>
    public UISettings UI { get; set; } = new();
    
    /// <summary>セキュリティ設定</summary>
    public SecuritySettings Security { get; set; } = new();
    
    /// <summary>パフォーマンス設定</summary>
    public PerformanceSettings Performance { get; set; } = new();
}

public class StartupSettings
{
    /// <summary>Windows起動時に自動起動するか</summary>
    public bool AutoStart { get; set; } = false;
    
    /// <summary>最後のセッションを自動復元するか</summary>
    public bool RestoreLastSession { get; set; } = false;
    
    /// <summary>アプリ終了時に現在の状態を自動保存するか</summary>
    public bool AutoSaveOnExit { get; set; } = true;
    
    /// <summary>システムトレイに最小化するか</summary>
    public bool MinimizeToTray { get; set; } = false;
}

public class UISettings
{
    /// <summary>メインウィンドウの位置とサイズ</summary>
    public WindowState MainWindow { get; set; } = new();
    
    /// <summary>テーマ設定</summary>
    public string Theme { get; set; } = "Light";
    
    /// <summary>言語設定</summary>
    public string Language { get; set; } = "ja-JP";
    
    /// <summary>フォント設定</summary>
    public FontSettings Font { get; set; } = new();
}

public class WindowState
{
    public double Left { get; set; } = 100;
    public double Top { get; set; } = 100;
    public double Width { get; set; } = 800;
    public double Height { get; set; } = 600;
    public bool IsMaximized { get; set; } = false;
}

public class FontSettings
{
    public string Family { get; set; } = "Yu Gothic UI";
    public double Size { get; set; } = 12;
}

public class SecuritySettings
{
    /// <summary>データファイル暗号化を有効にするか</summary>
    public bool EncryptDataFiles { get; set; } = false;
    
    /// <summary>暗号化キー（ハッシュ化済み）</summary>
    public string EncryptionKeyHash { get; set; }
    
    /// <summary>不正なパスアクセスをブロックするか</summary>
    public bool BlockInvalidPaths { get; set; } = true;
}

public class PerformanceSettings
{
    /// <summary>フォルダ存在チェックのタイムアウト（ミリ秒）</summary>
    public int FolderCheckTimeout { get; set; } = 5000;
    
    /// <summary>キャッシュの有効期限（分）</summary>
    public int CacheExpiration { get; set; } = 30;
    
    /// <summary>同時に開けるフォルダの最大数</summary>
    public int MaxConcurrentFolders { get; set; } = 20;
    
    /// <summary>バックグラウンドでのフォルダ監視を有効にするか</summary>
    public bool EnableFolderWatching { get; set; } = false;
}
```

## 2. データ永続化仕様

### 2.1 JSONファイル構造

#### sessions.json
```json
{
  "version": "1.0.0",
  "lastModified": "2024-08-31T18:30:00Z",
  "sessions": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "開発環境セッション",
      "description": "日常の開発作業用フォルダ群",
      "folders": [
        {
          "path": "C:\\Projects\\NextExplorer",
          "displayName": "NextExplorer",
          "exists": true,
          "isAccessible": true,
          "iconPath": "C:\\Windows\\System32\\shell32.dll,3",
          "lastAccessed": "2024-08-31T15:30:00Z",
          "type": "Local"
        }
      ],
      "createdAt": "2024-08-31T10:00:00Z",
      "updatedAt": "2024-08-31T15:30:00Z",
      "lastUsed": "2024-08-31T15:30:00Z",
      "usageCount": 15,
      "tags": ["開発", "プロジェクト"],
      "isFavorite": true,
      "isAutoGenerated": false
    }
  ]
}
```

#### config.json
```json
{
  "version": "1.0.0",
  "startup": {
    "autoStart": false,
    "restoreLastSession": false,
    "autoSaveOnExit": true,
    "minimizeToTray": false
  },
  "ui": {
    "mainWindow": {
      "left": 100,
      "top": 100,
      "width": 800,
      "height": 600,
      "isMaximized": false
    },
    "theme": "Light",
    "language": "ja-JP",
    "font": {
      "family": "Yu Gothic UI",
      "size": 12
    }
  },
  "security": {
    "encryptDataFiles": false,
    "encryptionKeyHash": null,
    "blockInvalidPaths": true
  },
  "performance": {
    "folderCheckTimeout": 5000,
    "cacheExpiration": 30,
    "maxConcurrentFolders": 20,
    "enableFolderWatching": false
  }
}
```

### 2.2 ファイルパス構成
```
%APPDATA%\NextExplorer\
├── sessions.json           # セッションデータ
├── config.json            # アプリケーション設定
├── sessions_backup.json   # セッションデータバックアップ
├── logs\                  # ログファイル格納フォルダ
│   ├── app_20240831.log
│   └── error_20240831.log
└── temp\                  # 一時ファイル格納フォルダ
    └── cache\             # キャッシュファイル
```

## 3. データ検証ルール

### 3.1 FolderInfo 検証
```csharp
public class FolderInfoValidator : AbstractValidator<FolderInfo>
{
    public FolderInfoValidator()
    {
        RuleFor(x => x.Path)
            .NotEmpty().WithMessage("パスは必須です")
            .MaximumLength(260).WithMessage("パスが長すぎます")
            .Must(BeValidPath).WithMessage("無効なパスです");
            
        RuleFor(x => x.DisplayName)
            .MaximumLength(255).WithMessage("表示名が長すぎます");
            
        RuleFor(x => x.LastAccessed)
            .LessThanOrEqualTo(DateTime.Now).WithMessage("未来の日時は設定できません");
    }
    
    private bool BeValidPath(string path)
    {
        return PathValidator.IsValidPath(path);
    }
}
```

### 3.2 SessionInfo 検証
```csharp
public class SessionInfoValidator : AbstractValidator<SessionInfo>
{
    public SessionInfoValidator()
    {
        RuleFor(x => x.Id)
            .NotEmpty().WithMessage("IDは必須です")
            .Must(BeValidGuid).WithMessage("無効なGUID形式です");
            
        RuleFor(x => x.Name)
            .NotEmpty().WithMessage("セッション名は必須です")
            .MaximumLength(100).WithMessage("セッション名が長すぎます");
            
        RuleFor(x => x.Description)
            .MaximumLength(500).WithMessage("説明が長すぎます");
            
        RuleFor(x => x.Folders)
            .NotEmpty().WithMessage("フォルダは1つ以上必要です")
            .Must(folders => folders.Count <= 50).WithMessage("フォルダ数が多すぎます");
            
        RuleForEach(x => x.Folders)
            .SetValidator(new FolderInfoValidator());
    }
    
    private bool BeValidGuid(string id)
    {
        return Guid.TryParse(id, out _);
    }
}
```

## 4. データベース設計（将来拡張用）

### 4.1 テーブル構造

#### Sessions テーブル
```sql
CREATE TABLE Sessions (
    Id NVARCHAR(36) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Description NVARCHAR(500),
    CreatedAt DATETIME2 NOT NULL,
    UpdatedAt DATETIME2 NOT NULL,
    LastUsed DATETIME2,
    UsageCount INT DEFAULT 0,
    IsFavorite BIT DEFAULT 0,
    IsAutoGenerated BIT DEFAULT 0
);
```

#### SessionFolders テーブル
```sql
CREATE TABLE SessionFolders (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    SessionId NVARCHAR(36) NOT NULL,
    Path NVARCHAR(260) NOT NULL,
    DisplayName NVARCHAR(255),
    FolderType INT DEFAULT 0,
    OrderIndex INT DEFAULT 0,
    FOREIGN KEY (SessionId) REFERENCES Sessions(Id) ON DELETE CASCADE
);
```

#### SessionTags テーブル
```sql
CREATE TABLE SessionTags (
    SessionId NVARCHAR(36) NOT NULL,
    Tag NVARCHAR(50) NOT NULL,
    PRIMARY KEY (SessionId, Tag),
    FOREIGN KEY (SessionId) REFERENCES Sessions(Id) ON DELETE CASCADE
);
```

## 5. データマイグレーション設計

### 5.1 バージョン管理
```csharp
public class DataMigrator
{
    public async Task<bool> MigrateIfNeededAsync(string currentVersion)
    {
        var dataVersion = await GetDataVersionAsync();
        
        return dataVersion switch
        {
            "1.0.0" when currentVersion == "1.1.0" => await MigrateFrom1_0_To1_1(),
            "1.1.0" when currentVersion == "1.2.0" => await MigrateFrom1_1_To1_2(),
            _ => false
        };
    }
    
    private async Task<bool> MigrateFrom1_0_To1_1()
    {
        // フォルダタイプ列の追加
        // 既存データへのデフォルト値設定
    }
}
```

### 5.2 データバックアップ戦略
- マイグレーション前の自動バックアップ
- 世代管理（最大10世代）
- 設定可能なバックアップ間隔